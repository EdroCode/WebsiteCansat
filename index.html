<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CanSat Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-4">

  <header class="text-center py-6">
    <img src="WebsiteCansat/Resources/CarlosAmarante.png" alt="Logo Carlos" class="h-16 mx-auto mb-4">
    <h1 class="text-3xl font-bold text-gray-800">Painel de Dados - CanSat</h1>
  </header>

  <div class="flex justify-center gap-4 mb-6">
    <button id="startButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-md transition">
      Iniciar
    </button>
    <button id="stopButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl shadow-md transition">
      Parar
    </button>
    <button id="resetButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition">
      Resetar
    </button>
    <button id="downloadCSV" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl shadow-md transition">
      Exportar CSV
    </button>
  </div>

  <hr class="my-10 border-t-4 border-gray-300">
  <h2 class="text-2xl font-bold mb-4">Painel de Controlo --
    
      Status: <span id="statusText" class="text-yellow-500 font-bold" >Parado</span>
    
  </h2>

  <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
    <div class="bg-white shadow rounded-xl p-4">
      <h2 class="text-xl font-semibold">Temperatura Interior</h2>
      <p id="tempValue" class="text-2xl">-- °C</p>
    </div>
    <div class="bg-white shadow rounded-xl p-4">
      <h2 class="text-xl font-semibold">Pressão Atmosférica</h2>
      <p id="pressureValue" class="text-2xl">-- hPa</p>
    </div>
    <div class="bg-white shadow rounded-xl p-4">
      <h2 class="text-xl font-semibold">Humidade Interior</h2>
      <p id="humidityValue" class="text-2xl">-- %</p>
    </div>
    <div class="bg-white shadow rounded-xl p-4">
      <h2 class="text-xl font-semibold">Altitude</h2>
      <p id="altitudeValue" class="text-2xl">-- m</p>
    </div>
    <div class="bg-white shadow rounded-xl p-4">
      <h2 class="text-xl font-semibold">Latitude</h2>
      <p id="latValue" class="text-2xl">--</p>
    </div>
    <div class="bg-white shadow rounded-xl p-4">
      <h2 class="text-xl font-semibold">Longitude</h2>
      <p id="lonValue" class="text-2xl">--</p>
    </div>
    <div class="bg-white shadow rounded-xl p-4">
      <h2 class="text-xl font-semibold">Temperatura PI</h2>
      <p id="PIvalue" class="text-2xl">-- °C</p>
    </div>
    
  </div>

  <hr class="my-10 border-t-4 border-gray-300">
  <h2 class="text-2xl font-bold mb-4">Gráficos</h2>

  <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white shadow rounded-xl p-4">
      <h3 class="text-lg font-semibold mb-2">Temperatura Interior</h3>
      <canvas id="tempChart"></canvas>
    </div>
    <div class="bg-white shadow rounded-xl p-4">
      <h3 class="text-lg font-semibold mb-2">Humidade Interior</h3>
      <canvas id="humidityChart"></canvas>
    </div>
    <div class="bg-white shadow rounded-xl p-4">
      <h3 class="text-lg font-semibold mb-2">Pressão Atmosférica</h3>
      <canvas id="pressureChart"></canvas>
    </div>
  </div>

  <hr class="my-10 border-t-4 border-gray-300">
  <h2 class="text-2xl font-bold mb-4 text-left">Localização em Tempo Real</h2>
  <div id="map" class="w-full h-96 rounded-xl shadow-md"></div>
  <hr class="my-10 border-t-4 border-gray-300">
  <div class="mt-2 mb-4 px-2 flex justify-between items-center">
    <div class="text-left space-x-4">
      <label>
        [ Made by <a href="https://github.com/EdroCode" target="_blank" class="text-blue-600 underline">Edro</a> ]
      </label>
      <span>Hora atual: <span id="clock">--:--:--</span></span>
    </div>
  </div>

  <script>
    const tempChart = new Chart(document.getElementById('tempChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Temperatura (°C)',
          borderColor: 'rgb(255, 99, 132)',
          data: []
        }]
      },
      options: { responsive: true }
    });

    const humidityChart = new Chart(document.getElementById('humidityChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Humidade (%)',
          borderColor: 'rgb(75, 192, 192)',
          data: []
        }]
      },
      options: { responsive: true }
    });

    const pressureChart = new Chart(document.getElementById('pressureChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Pressão (hPa)', 
          borderColor: 'rgb(36, 199, 36)',
          data: []
        }]
      },
      options: { responsive: true }
    });

    const map = L.map('map').setView([-20.319968201007146, -40.33845612875748], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const marker = L.marker([38.0, -9.0]).addTo(map).bindPopup("Satélite");

    function updateMap(lat, lon) {
      marker.setLatLng([lat, lon]);
      map.setView([lat, lon], map.getZoom());
    }

    let eventSource = null;
    let collectedData = [];

    function updateClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('pt-PT');
      document.getElementById('clock').textContent = timeString;
    }

    function startDataUpdate() {

      document.getElementById('statusText').textContent = "Atualizando...";
      document.getElementById('statusText').classList.remove('text-yellow-500');
      document.getElementById('statusText').classList.add('text-green-500');

      eventSource = new EventSource('http://localhost:5000/stream');

      eventSource.onmessage = function(event) {


        document.getElementById('statusText').classList.remove('text-red-500');
        document.getElementById('statusText').classList.add('text-green-500');
        const data = JSON.parse(event.data);
        const now = new Date().toLocaleTimeString();

        console.log(data)

        collectedData.push({
          timestamp: now,
          temperature: data.temperature,
          humidity: data.humidity,
          pressure: data.pressure,
          altitude: data.altitude,
          latitude: data.latitude,
          longitude: data.longitude,
          pi_temp: data.pi_temp
        });

        tempChart.data.labels.push(now);
        humidityChart.data.labels.push(now);
        pressureChart.data.labels.push(now);
        tempChart.data.datasets[0].data.push(data.temperature);
        humidityChart.data.datasets[0].data.push(data.humidity);
        pressureChart.data.datasets[0].data.push(data.pressure);
        tempChart.update();
        humidityChart.update();
        pressureChart.update();

        document.getElementById('tempValue').textContent = `${data.temperature} °C`;
        document.getElementById('humidityValue').textContent = `${data.humidity} %`;
        document.getElementById('pressureValue').textContent = `${data.pressure} hPa`;
        document.getElementById('altitudeValue').textContent = `${data.altitude} m`;
        document.getElementById('latValue').textContent = data.latitude;
        document.getElementById('lonValue').textContent = data.longitude;
        document.getElementById('PIvalue').textContent = `${data.pi_temp} °C`;

        updateMap(data.latitude, data.longitude);
      };

      eventSource.onerror = function() {
        document.getElementById('statusText').textContent = "Erro na Conexão!";
        document.getElementById('statusText').classList.remove('text-green-500');
        document.getElementById('statusText').classList.add('text-red-500');
        stopDataUpdate(); 
        // alert("Não foi possível conectar ao servidor. Verifique a conexão.");
      };
    }

    function stopDataUpdate() {
      document.getElementById('statusText').classList.remove('text-green-500');
      document.getElementById('statusText').classList.add('text-yellow-500');
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
    }
    function stop() {
      document.getElementById('statusText').textContent = "Parado";
      stopDataUpdate()
    }
   

    function resetData() {
      collectedData = [];
      tempChart.data.labels = [];
      tempChart.data.datasets[0].data = [];
      humidityChart.data.labels = [];
      humidityChart.data.datasets[0].data = [];
      pressureChart.data.labels = [];
      pressureChart.data.datasets[0].data = [];
      tempChart.update();
      humidityChart.update();
      pressureChart.update();

      document.getElementById('tempValue').textContent = "-- °C";
      document.getElementById('humidityValue').textContent = "-- %";
      document.getElementById('pressureValue').textContent = "-- hPa";
      document.getElementById('altitudeValue').textContent = "-- m";
      document.getElementById('latValue').textContent = "--";
      document.getElementById('lonValue').textContent = "--";
      document.getElementById('PIvalue').textContent = "-- °C";
    }

    document.getElementById('startButton').addEventListener('click', startDataUpdate);
    document.getElementById('stopButton').addEventListener('click', stop);
    document.getElementById('resetButton').addEventListener('click', resetData);
    document.getElementById('downloadCSV').addEventListener('click', exportToCSV);
    setInterval(updateClock, 1000);


    function exportToCSV() {
    const headers = ['Timestamp', 'Temperature (°C)', 'Humidity (%)', 'Pressure (hPa)', 'Altitude (m)', 'Latitude', 'Longitude', 'PI Temperature (°C)'];
    const rows = collectedData.map(item => [
      item.timestamp, 
      item.temperature, 
      item.humidity, 
      item.pressure, 
      item.altitude, 
      item.latitude, 
      item.longitude, 
      item.pi_temp
    ])
  
      const csvContent = "data:text/csv;charset=utf-8," 
      + headers.join(",") + "\n" 
      + rows.map(row => row.join(",")).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "canSatData.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

  };


  </script>
</body>
</html>
